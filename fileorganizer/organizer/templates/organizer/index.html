{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>File Organizer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        --hover-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        --border-radius: 16px;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .main-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .header-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 2.5rem;
        margin-bottom: 2rem;
        text-align: center;
        border: none;
        position: relative;
        overflow: hidden;
      }

      .header-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
      }

      .header-title {
        color: #2d3748;
        font-weight: 700;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
      }

      .header-subtitle {
        color: #718096;
        font-size: 1.1rem;
        margin-bottom: 0;
      }

      .search-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 2rem;
        margin-bottom: 2rem;
        border: none;
      }

      .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f7fafc;
      }

      .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background: white;
      }

      .btn-analyze {
        background: var(--primary-gradient);
        border: none;
        border-radius: 12px;
        padding: 1rem 2rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .btn-analyze:hover {
        transform: translateY(-2px);
        box-shadow: var(--hover-shadow);
        color: white;
      }

      .btn-make-changes {
        background: var(--success-gradient);
        border: none;
        border-radius: 12px;
        padding: 1rem 2rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
        display: none;
      }

      .btn-make-changes:hover {
        transform: translateY(-2px);
        box-shadow: var(--hover-shadow);
        color: white;
      }

      .results-container {
        margin-top: 2rem;
      }

      .accordion {
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
        border: none;
      }

      .accordion-item {
        border: none;
        margin-bottom: 1px;
        background: white;
      }

      .accordion-item:first-of-type {
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
      }

      .accordion-item:last-of-type {
        border-bottom-left-radius: var(--border-radius);
        border-bottom-right-radius: var(--border-radius);
      }

      .accordion-header {
        border-radius: 0;
      }

      .accordion-button {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: none;
        padding: 1.5rem 2rem;
        font-weight: 600;
        color: #2d3748;
        transition: all 0.3s ease;
        border-radius: 0;
      }

      .accordion-button:not(.collapsed) {
        background: var(--primary-gradient);
        color: white;
        box-shadow: none;
      }

      .accordion-button:focus {
        box-shadow: none;
        border-color: transparent;
      }

      .accordion-button::after {
        transition: transform 0.3s ease;
      }

      .accordion-body {
        padding: 2rem;
        background: #f8fafc;
      }

      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .file-item {
        background: white;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border-left: 3px solid #667eea;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .file-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .file-item:last-child {
        margin-bottom: 0;
      }

      .category-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--primary-gradient);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-left: auto;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
      }

      .spinner-border {
        color: #667eea;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .success-message {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        margin-top: 1rem;
        display: none;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .error-message {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        margin-top: 1rem;
        display: none;
        animation: slideDown 0.3s ease;
      }

      @media (max-width: 768px) {
        .main-container {
          padding: 1rem;
        }
        
        .header-title {
          font-size: 2rem;
        }
        
        .header-card, .search-card {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Header -->
      <div class="header-card">
        <h1 class="header-title">
          <i class="fas fa-folder-open"></i>
          File Categorizer
        </h1>
        <p class="header-subtitle">
          Organize your files intelligently with AI-powered categorization
        </p>
      </div>

      <!-- Search Form -->
      <div class="search-card">
        <form id="analyzeForm">
          <div class="input-group">
            <input
              type="text"
              id="folderPath"
              name="folder_path"
              class="form-control"
              placeholder="Enter folder path (e.g., /home/user/documents)"
            />
            <button type="submit" class="btn btn-analyze">
              <i class="fas fa-search me-2"></i>
              Analyze Folder
            </button>
          </div>
        </form>
        
        <div class="loading-spinner" id="loadingSpinner">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Analyzing your files...</p>
        </div>
        
        <div class="success-message" id="successMessage">
          <i class="fas fa-check-circle me-2"></i>
          <span id="successText"></span>
        </div>
        
        <div class="error-message" id="errorMessage">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span id="errorText"></span>
        </div>
      </div>

      <!-- Results -->
      <div class="results-container">
        <div id="results" class="accordion"></div>
        
        <!-- Make Changes Button -->
        <div class="text-center mt-4">
          <button id="makeChangesBtn" class="btn btn-make-changes">
            <i class="fas fa-magic me-2"></i>
            Organize Files
          </button>
        </div>
      </div>
    </div>

    <script>
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      const csrftoken = getCookie("csrftoken");

      function showMessage(type, message) {
        const messageEl = document.getElementById(`${type}Message`);
        const textEl = document.getElementById(`${type}Text`);
        textEl.textContent = message;
        messageEl.style.display = 'block';
        setTimeout(() => {
          messageEl.style.display = 'none';
        }, 5000);
      }

      function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
          pdf: 'fas fa-file-pdf text-danger',
          doc: 'fas fa-file-word text-primary',
          docx: 'fas fa-file-word text-primary',
          xls: 'fas fa-file-excel text-success',
          xlsx: 'fas fa-file-excel text-success',
          ppt: 'fas fa-file-powerpoint text-warning',
          pptx: 'fas fa-file-powerpoint text-warning',
          txt: 'fas fa-file-alt text-secondary',
          jpg: 'fas fa-file-image text-info',
          jpeg: 'fas fa-file-image text-info',
          png: 'fas fa-file-image text-info',
          gif: 'fas fa-file-image text-info',
          mp4: 'fas fa-file-video text-purple',
          avi: 'fas fa-file-video text-purple',
          mp3: 'fas fa-file-audio text-success',
          wav: 'fas fa-file-audio text-success',
          zip: 'fas fa-file-archive text-warning',
          rar: 'fas fa-file-archive text-warning',
          default: 'fas fa-file text-muted'
        };
        return iconMap[ext] || iconMap.default;
      }

      document.getElementById("analyzeForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        let folderPath = document.getElementById("folderPath").value.trim();
        
        if (!folderPath) {
          showMessage('error', 'Please enter a folder path');
          return;
        }

        // Show loading
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("results").innerHTML = "";
        document.getElementById("makeChangesBtn").style.display = "none";

        try {
          let response = await fetch("/analyze/", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrftoken,
            },
            body: "folder_path=" + encodeURIComponent(folderPath),
          });

          let data = await response.json();
          document.getElementById("loadingSpinner").style.display = "none";

          if (data.error) {
            showMessage('error', data.error);
            return;
          }

          let categorized = data.data;
          let resultsDiv = document.getElementById("results");
          resultsDiv.innerHTML = "";

          let i = 0;
          let totalFiles = 0;
          
          for (let category in categorized) {
            let files = categorized[category];
            if (files.length === 0) continue;
            
            totalFiles += files.length;

            let accordionItem = `
              <div class="accordion-item fade-in" style="animation-delay: ${i * 0.1}s">
                <h2 class="accordion-header" id="heading${i}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}">
                    <i class="fas fa-folder me-2"></i>
                    ${category}
                    <span class="category-badge">
                      <i class="fas fa-file me-1"></i>
                      ${files.length}
                    </span>
                  </button>
                </h2>
                <div id="collapse${i}" class="accordion-collapse collapse" data-bs-parent="#results">
                  <div class="accordion-body">
                    <ul class="file-list">
                      ${files.map(f => `
                        <li class="file-item">
                          <i class="${getFileIcon(f)} me-2"></i>
                          ${f}
                        </li>
                      `).join("")}
                    </ul>
                  </div>
                </div>
              </div>`;
            resultsDiv.innerHTML += accordionItem;
            i++;
          }

          if (totalFiles > 0) {
            showMessage('success', `Found ${totalFiles} files in ${i} categories`);
            document.getElementById("makeChangesBtn").style.display = "inline-block";
          }

          // Store categorized data for make changes
          document.getElementById("makeChangesBtn").onclick = async function () {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Organizing...';
            
            try {
              let response2 = await fetch("/make-changes/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                  "X-CSRFToken": csrftoken,
                },
                body:
                  "folder_path=" +
                  encodeURIComponent(folderPath) +
                  "&categorized=" +
                  encodeURIComponent(JSON.stringify(categorized)),
              });

              let result = await response2.json();
              if (result.status === "success") {
                showMessage('success', 'Files organized successfully!');
                this.innerHTML = '<i class="fas fa-check me-2"></i>Completed';
              } else {
                showMessage('error', 'Failed to organize files');
                this.innerHTML = '<i class="fas fa-magic me-2"></i>Organize Files';
                this.disabled = false;
              }
            } catch (error) {
              showMessage('error', 'An error occurred while organizing files');
              this.innerHTML = '<i class="fas fa-magic me-2"></i>Organize Files';
              this.disabled = false;
            }
          };

        } catch (error) {
          document.getElementById("loadingSpinner").style.display = "none";
          showMessage('error', 'Network error. Please try again.');
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>