{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>File Organizer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="p-4">
    <div class="container">
      <h2 class="mb-3">ðŸ“‚ File Categorizer</h2>

      <!-- Folder Input -->
      <form id="analyzeForm">
        <div class="input-group mb-3">
          <input
            type="text"
            id="folderPath"
            name="folder_path"
            class="form-control"
            placeholder="Enter folder path"
          />
          <button type="submit" class="btn btn-primary">Analyze</button>
        </div>
      </form>

      <!-- Accordion Result -->
      <div id="results" class="accordion"></div>

      <!-- Make Changes Button -->
      <button
        id="makeChangesBtn"
        class="btn btn-success mt-3"
        style="display: none"
      >
        Make Changes
      </button>
    </div>
    <script>
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      const csrftoken = getCookie("csrftoken");
    </script>

    <script>
      document
        .getElementById("analyzeForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          let folderPath = document.getElementById("folderPath").value;

          let response = await fetch("/analyze/", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrftoken,
            },
            body: "folder_path=" + encodeURIComponent(folderPath),
          });

          let data = await response.json();

          if (data.error) {
            alert(data.error);
            return;
          }

          let categorized = data.data;
          let resultsDiv = document.getElementById("results");
          resultsDiv.innerHTML = "";

          let i = 0;
          for (let category in categorized) {
            let files = categorized[category];
            if (files.length === 0) continue;

            let accordionItem = `
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading${i}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}">
                    ${category} (${files.length})
                </button>
            </h2>
            <div id="collapse${i}" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <ul>${files.map((f) => `<li>${f}</li>`).join("")}</ul>
                </div>
            </div>
        </div>`;
            resultsDiv.innerHTML += accordionItem;
            i++;
          }

          // Show make changes button
          document.getElementById("makeChangesBtn").style.display = "block";

          // Store categorized data
          document.getElementById("makeChangesBtn").onclick =
            async function () {
              let response2 = await fetch("/make-changes/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                },
                body:
                  "folder_path=" +
                  encodeURIComponent(folderPath) +
                  "&categorized=" +
                  encodeURIComponent(JSON.stringify(categorized)),
              });

              let result = await response2.json();
              if (result.status === "success") {
                alert("âœ… Files organized successfully!");
              }
            };
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
